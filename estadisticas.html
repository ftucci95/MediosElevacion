<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Estadísticas de Medios de Elevación</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <!-- Agregamos Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: white;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1, h2 {
            color: #333;
        }

        .filters {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .filters select, .filters input {
            margin: 5px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            margin-top: 0;
            color: #666;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #007bff;
            color: white;
            cursor: pointer;
            position: relative;
            padding-right: 20px;
        }

        th:hover {
            background-color: #0056b3;
        }

        th.sort-asc::after {
            content: "▲";
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
        }

        th.sort-desc::after {
            content: "▼";
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
        }

        tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        tr:hover {
            background-color: #f2f2f2;
        }

        .status-operativo {
            color: #28a745;
            font-weight: bold;
        }

        .status-no-operativo {
            color: #dc3545;
            font-weight: bold;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .button-container {
            margin-top: 20px;
            text-align: right;
        }

        button {
            padding: 10px 20px;
            font-size: 14px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            transition: background-color 0.3s;
            margin-left: 10px;
        }

        button:hover {
            background-color: #0056b3;
        }

        .home-button {
            background-color: #28a745;
        }

        .home-button:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Estadísticas de Medios de Elevación</h1>
        
        <!-- Filtros -->
        <div class="filters">
            <select id="lineaFilter">
                <option value="">Todas las líneas</option>
                <option value="Línea A">Línea A</option>
                <option value="Línea B">Línea B</option>
                <option value="Línea C">Línea C</option>
                <option value="Línea D">Línea D</option>
                <option value="Línea E">Línea E</option>
                <option value="Línea H">Línea H</option>
            </select>
            <input type="date" id="fechaFilter" />
            <select id="estadoFilter">
                <option value="">Todos los estados</option>
                <option value="Operativo">Operativo</option>
                <option value="No operativo">No operativo</option>
            </select>
        </div>

        <!-- Estadísticas generales -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total de Registros</h3>
                <div id="totalRegistros" class="stat-value">-</div>
            </div>
            <div class="stat-card">
                <h3>Tiempo Detenido Hoy</h3>
                <div id="mediosNoOperativos" class="stat-value">-</div>
            </div>
            <div class="stat-card">
                <h3>Disponibilidad del Día</h3>
                <div id="disponibilidadPromedio" class="stat-value">-</div>
            </div>
        </div>

        <!-- Tabla de estadísticas -->
        <table id="statsTable">
            <thead>
                <tr>
                    <th onclick="sortTable('linea')">Línea</th>
                    <th onclick="sortTable('estacion')">Estación</th>
                    <th onclick="sortTable('medioElevacion')">Medio de Elevación</th>
                    <th onclick="sortTable('cantidadFallas')">Cantidad de Fallas</th>
                    <th onclick="sortTable('tiempoDetenido')">Tiempo Detenido</th>
                    <th onclick="sortTable('disponibilidad')">Disponibilidad (%)</th>
                    <th onclick="sortTable('estado')">Estado Actual</th>
                </tr>
            </thead>
            <tbody id="statsTableBody"></tbody>
        </table>

        <!-- Contenedor para el gráfico -->
        <div class="chart-container">
            <canvas id="statsChart"></canvas>
        </div>

        <!-- Botones de navegación -->
        <div class="button-container">
            <button onclick="window.location.href='index.html'" class="home-button">Volver al Inicio</button>
        </div>
    </div>

    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyABQPwFyxEBbzFy1nXgmP_9DCOJ6Tl8XRs",
            authDomain: "medioselevacion-1a482.firebaseapp.com",
            projectId: "medioselevacion-1a482",
            storageBucket: "medioselevacion-1a482.appspot.com",
            messagingSenderId: "30574051443",
            appId: "1:30574051443:web:e7f5b6c6c7b4405e8db710",
            measurementId: "G-KQXMBG7TF0"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let chart = null;
        let currentData = [];
        let sortColumn = '';
        let sortDirection = 'asc';

        // Función para formatear fechas
        function formatDate(timestamp) {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate();
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            const diffHours = Math.floor(diffTime / (1000 * 60 * 60));
            const diffMinutes = Math.floor(diffTime / (1000 * 60));

            if (diffDays > 0) {
                return `Hace ${diffDays} día${diffDays === 1 ? '' : 's'}`;
            } else if (diffHours > 0) {
                return `Hace ${diffHours} hora${diffHours === 1 ? '' : 's'}`;
            } else if (diffMinutes > 0) {
                return `Hace ${diffMinutes} minuto${diffMinutes === 1 ? '' : 's'}`;
            } else {
                return 'Hace unos segundos';
            }
        }

        // Función para calcular la disponibilidad
        function calcularDisponibilidad(registros) {
            if (!registros || registros.length === 0) return 0;
            const operativos = registros.filter(r => r.estado === 'Operativo').length;
            return ((operativos / registros.length) * 100).toFixed(1);
        }

        // Función para formatear minutos en horas y minutos
        function formatearTiempoDetenido(minutos) {
            if (!minutos) return '0 minutos';
            const horas = Math.floor(minutos / 60);
            const minutosRestantes = minutos % 60;
            if (horas > 0) {
                return `${horas}h ${minutosRestantes}min`;
            }
            return `${minutosRestantes} minutos`;
        }

        // Función para obtener fecha en zona horaria Argentina
        function obtenerFechaArgentina() {
            const now = new Date();
            return new Date(now.toLocaleString('en-US', { timeZone: 'America/Argentina/Buenos_Aires' }))
                .toISOString().split('T')[0];
        }

        // Función para cargar y mostrar los datos
        async function cargarDatos() {
            try {
                const fecha = document.getElementById('fechaFilter').value || obtenerFechaArgentina();
                
                const snapshot = await db.collection("estadisticasDiarias")
                    .where('fecha', '==', fecha)
                    .get();

                // Procesar los datos
                currentData = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const estadoActual = data.estadisticas.estados[data.estadisticas.estados.length - 1];
                    return {
                        id: doc.id,
                        linea: data.linea,
                        estacion: data.estacion,
                        medioElevacion: data.medioElevacion,
                        cantidadFallas: data.estadisticas.cantidadFallas,
                        tiempoDetenido: data.estadisticas.tiempoNoOperativo || 0,
                        tiempoTotalServicio: data.estadisticas.tiempoTotalServicio || 0,
                        disponibilidad: data.estadisticas.tiempoTotalServicio > 0 
                            ? (((data.estadisticas.tiempoTotalServicio - data.estadisticas.tiempoNoOperativo) / data.estadisticas.tiempoTotalServicio) * 100).toFixed(1)
                            : '0.0',
                        estado: estadoActual ? estadoActual.estado : 'Sin datos'
                    };
                });

                aplicarFiltros();
            } catch (error) {
                console.error("Error al cargar los datos:", error);
            }
        }

        // Función para aplicar filtros
        function aplicarFiltros() {
            const lineaFilter = document.getElementById('lineaFilter').value;
            const estadoFilter = document.getElementById('estadoFilter').value;

            let datosFiltrados = [...currentData];

            if (lineaFilter) {
                datosFiltrados = datosFiltrados.filter(item => item.linea === lineaFilter);
            }

            if (estadoFilter) {
                datosFiltrados = datosFiltrados.filter(item => item.estado === estadoFilter);
            }

            // Actualizar estadísticas
            document.getElementById('totalRegistros').textContent = datosFiltrados.length;
            
            const tiempoTotalDetenido = datosFiltrados.reduce((acc, item) => acc + (item.tiempoDetenido || 0), 0);
            document.getElementById('mediosNoOperativos').textContent = formatearTiempoDetenido(tiempoTotalDetenido);
            
            const tiempoTotalServicio = datosFiltrados.reduce((acc, item) => acc + item.tiempoTotalServicio, 0);
            const disponibilidadPromedio = tiempoTotalServicio > 0 
                ? (((tiempoTotalServicio - tiempoTotalDetenido) / tiempoTotalServicio) * 100).toFixed(1) + '%'
                : '0%';
            document.getElementById('disponibilidadPromedio').textContent = disponibilidadPromedio;

            // Actualizar tabla
            const tbody = document.getElementById('statsTableBody');
            tbody.innerHTML = '';

            datosFiltrados.forEach(item => {
                const row = tbody.insertRow();
                const estadoClass = item.estado === 'Operativo' ? 'status-operativo' : 'status-no-operativo';
                row.innerHTML = `
                    <td>${item.linea}</td>
                    <td>${item.estacion}</td>
                    <td>${item.medioElevacion}</td>
                    <td>${item.cantidadFallas}</td>
                    <td>${formatearTiempoDetenido(item.tiempoDetenido)}</td>
                    <td>${item.disponibilidad}%</td>
                    <td class="${estadoClass}">${item.estado}</td>
                `;
            });

            actualizarGrafico(datosFiltrados);
        }

        // Función para ordenar la tabla
        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }

            // Remover clases de ordenamiento previas
            document.querySelectorAll('th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });

            // Agregar clase de ordenamiento actual
            const th = document.querySelector(`th[onclick="sortTable('${column}')"]`);
            th.classList.add(`sort-${sortDirection}`);

            const tbody = document.getElementById('statsTableBody');
            const rows = Array.from(tbody.getElementsByTagName('tr'));

            rows.sort((a, b) => {
                let aValue = a.cells[getColumnIndex(column)].textContent;
                let bValue = b.cells[getColumnIndex(column)].textContent;

                if (column === 'tiempoDetenido') {
                    // Convertir texto de tiempo a minutos para comparación
                    aValue = convertTimeToMinutes(aValue);
                    bValue = convertTimeToMinutes(bValue);
                } else if (column === 'disponibilidad') {
                    // Convertir porcentaje a número
                    aValue = parseFloat(aValue);
                    bValue = parseFloat(bValue);
                }

                if (sortDirection === 'asc') {
                    return aValue > bValue ? 1 : -1;
                } else {
                    return aValue < bValue ? 1 : -1;
                }
            });

            rows.forEach(row => tbody.appendChild(row));
        }

        // Función auxiliar para obtener el índice de la columna
        function getColumnIndex(column) {
            const columns = {
                'linea': 0,
                'estacion': 1,
                'medioElevacion': 2,
                'cantidadFallas': 3,
                'tiempoDetenido': 4,
                'disponibilidad': 5,
                'estado': 6
            };
            return columns[column];
        }

        // Función auxiliar para convertir tiempo a minutos
        function convertTimeToMinutes(timeText) {
            const numbers = timeText.match(/\d+/);
            if (!numbers) return 0;
            const number = parseInt(numbers[0]);
            if (timeText.includes('h')) {
                return number * 60;
            }
            return number;
        }

        // Función para actualizar el gráfico
        function actualizarGrafico(datos) {
            const ctx = document.getElementById('statsChart').getContext('2d');
            
            // Destruir gráfico anterior si existe
            if (chart) {
                chart.destroy();
            }

            // Preparar datos para el gráfico
            const lineas = [...new Set(datos.map(item => item.linea))];
            const disponibilidadPorLinea = lineas.map(linea => {
                const mediosDeLinea = datos.filter(item => item.linea === linea);
                if (mediosDeLinea.length === 0) return 0;
                return (mediosDeLinea.reduce((acc, item) => acc + parseFloat(item.disponibilidad), 0) / mediosDeLinea.length).toFixed(1);
            });

            // Crear nuevo gráfico
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: lineas,
                    datasets: [{
                        label: 'Disponibilidad por Línea (%)',
                        data: disponibilidadPorLinea,
                        backgroundColor: 'rgba(0, 123, 255, 0.5)',
                        borderColor: 'rgba(0, 123, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        // Al cargar la página
        document.addEventListener('DOMContentLoaded', () => {
            // Establecer la fecha de hoy en el input
            document.getElementById('fechaFilter').value = obtenerFechaArgentina();
            
            // Agregar event listeners
            document.getElementById('lineaFilter').addEventListener('change', aplicarFiltros);
            document.getElementById('estadoFilter').addEventListener('change', aplicarFiltros);
            document.getElementById('fechaFilter').addEventListener('change', cargarDatos);
            
            // Cargar datos iniciales
            cargarDatos();
        });
    </script>
</body>
</html>
